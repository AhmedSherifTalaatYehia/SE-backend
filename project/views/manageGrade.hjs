<!DOCTYPE html>
<html>
  <head>
    <title>Manage Grade</title>
    <link rel='stylesheet' href='/styles/bootstrap.min.css' />
    <link rel='stylesheet' href='/styles/style.css' />
    <script src="/js/jquery-2.2.0.min.js" type="text/javascript"></script>
    <script src="/js/bootstrap.min.js" type="text/javascript"></script>
  </head>
  <body>
      <script>
      $(document).ready(function() {
        
        var gradesArray = [];
        var cid;
        const sessionToken = document.cookie.includes('session_token');
        if (!sessionToken) {
          location.href = '/';
        }

        $(".dropdown-menu li a").click(function(){
          const index = $(this).attr('index');
          cid = index;
          $("#courseDropdown").attr('index', index);
          $("#courseDropdown").text($(this).text());
          $("#tbody").empty();
          $("#thead").empty();

          
          $.ajax({
          type: "GET",
          url: `/api/v1/enrollment/${index}`,
          success: function(data) {
              console.log(data);
              $('#thead').append(`
                      <tr>
                        <th class="text-center">ID</th>
                        <th class="text-center">Name</th>
                        <th class="text-center">Grade</th>
                      </tr>
                `);
                for( let i = 0; i<data.length;i++ ){
                  let row = data[i]  
                  $('#tbody').append(
                        `<tr>
                              <td class="text-center">${row.userId}</td>
                              <td class="text-center">${row.firstName} ${row.lastName}</td>
                              <td class="text-center">
                                <div class="col-sm-10">
                                    <input type="text"  id="${i}" name="salary" placeholder="Enter grade" value="${row.gradeName}" required >
                                </div>
                              </td>
                        </tr>`);
                    gradesArray.push({id : row.userId, grade : row.gradeName});
                  }
                $('#div-btn').css("display","block");
              
            },
            error: function(errorResponse) {
              if(errorResponse) {
                alert(`User login error: ${errorResponse.responseText}`);
              }            
            }
          });
          

          });

      $('#update').click(function(){
        if($('#div-btn').css("display") == 'none'){
            return;
        }
        let gradesNumericValue = {
        "A+": 0.7,"A": 1,"A-": 1.3,
        "B+": 1.7,"B": 2,"B-": 2.3,
        "C+": 2.7,"C": 3,"C-": 3.3,
        "D+": 3.7,"D": 4,"F": 5,
        };
        const updatedGradesArray = [];
        for(let i = 0;i<gradesArray.length;i++){
          let newGrade = $(`#${i}`).val();
          let gradeValue = gradesNumericValue[newGrade];
          if(!gradeValue){
            alert(`Invalid grade entry for user Id ${gradesArray[i].id}`);
            return;
          }
          if(gradesArray[i].grade != newGrade){
              gradesArray[i].grade = gradeValue;
              updatedGradesArray.push(gradesArray[i]);
          }

        }
        console.log("here",cid)
        console.log("here",updatedGradesArray)
        const obj = {row : updatedGradesArray};
        if(updatedGradesArray.length == 0){
          alert("updated successfully ..");
          return;
        }

        $.ajax({
            type: "PUT",
            url: '/api/v1/enrollment/'+cid,
            data: obj,
            success: function(data){
              if(data) {
                console.log(data);
                $('#tbody').empty();
                $('#thead').empty();
                $('#div-btn').css("display","none");
                alert(data);
              }
            },
            error: function(errorResponse) {
              if(errorResponse) {
                alert(`User login error: ${errorResponse.responseText}`);
              }            
            }
          });

    });
      });
      </script> 
    <div>
      <div>
        <nav class="navbar navbar-inverse" style="padding-left:130px;">
          <ul class="nav navbar-nav">
            <li><a href="/dashboard">Home</a></li>
            <li class="active"><a href="/manage/grades">Grades</a></li>
            <li><a href="/manage/courses">Courses</a></li>
            <li><a href="/manage/transfers">Requests</a></li>
            <li><a href="/">Logout</a></li>
          </ul>
       </nav>
      <form class="form-horizontal" style="width: 50%;padding-left: 100px">
      <div class="form-group">
          <label for="faculty" class="col-sm-2 control-label">Courses</label>
          <div class="col-sm-10">
            <div class="btn-group">
              <button index=0 id='courseDropdown' class="btn">Course Code</button>
              <button class="btn dropdown-toggle" data-toggle="dropdown">
                <span class="caret"></span>
              </button>
              <ul class="dropdown-menu">
                  {{#courses}}
                     <li><a index="{{id}}">{{code}}</a></li>
                  {{/courses}}              
              </ul>
            </div>
          </div>
      </div>
  </form>
  <table class="table">
          <thead id = "thead">
          
          </thead>
          <tbody id = "tbody">
            
          </tbody>
      </table>
       <div class="center" style="display : none" id = "div-btn">
            <input id="update" name="updateBtn" type="button" value="Update" class="btn btn-primary">
     </div>
  </body>
  </html>
